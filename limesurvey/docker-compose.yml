version: '3'

services:
    db:
        image: postgres:alpine

        entrypoint: >
            /bin/ash -c '
                set -ex ;

                echo "
                    CREATE USER $$LIMESURVEY_DB_USER WITH PASSWORD '\''$$LIMESURVEY_DB_PASSWORD'\'' ;
                    CREATE DATABASE $$LIMESURVEY_DB OWNER $$LIMESURVEY_DB_USER ;
                    GRANT ALL PRIVILEGES ON DATABASE $$LIMESURVEY_DB TO $$LIMESURVEY_DB_USER ;
                " > /docker-entrypoint-initdb.d/create_limesurvey.sql ;
                
                /docker-entrypoint.sh postgres ;
            '

        environment:
            - POSTGRES_PASSWORD=password
            - POSTGRES_DB=database
            - POSTGRES_USER=postgres
            - LIMESURVEY_DB=limesurvey_db
            - LIMESURVEY_DB_USER=limesurvey_user
            - LIMESURVEY_DB_PASSWORD=limesurvey_password

    limesurvey:
        build: .

        environment:
            - LIMESURVEY_PORT=8080
            - LIMESURVEY_DB_TYPE=pgsql
            - LIMESURVEY_DB_HOST=db
            - LIMESURVEY_DB_PORT=5432
            - LIMESURVEY_DB_NAME=limesurvey_db
            - LIMESURVEY_DB_TABLE_PREFIX=lime_
            - LIMESURVEY_DB_USERNAME=limesurvey_user
            - LIMESURVEY_DB_PASSWORD=limesurvey_password
            - LIMESURVEY_ADMIN_USER=limesurvey_admin
            - LIMESURVEY_ADMIN_NAME=limesurvey_admin
            - LIMESURVEY_ADMIN_EMAIL=limesurvey@limemail.com
            - LIMESURVEY_ADMIN_PASSWORD=limesurvey_admin_password
            - LIMESURVEY_URL_FORMAT=path

        ports:
            - "8080:8080"

        depends_on:
            - db
